FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
# Install system dependencies as root
USER root

RUN apt-get update && \
    apt-get install -y \
    python3 python3-pip python3-gi python3-gst-1.0 \
    gstreamer1.0-tools \
    gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-good \
    gstreamer1.0-plugins-bad \
    gstreamer1.0-plugins-ugly \
    gstreamer1.0-libav \
    libgirepository1.0-dev \
    && apt-get clean && rm -rf /var/lib/apt/lists/*
    
USER $APP_UID
ARG APP_UID
USER ${APP_UID}

WORKDIR /app
EXPOSE 8080
EXPOSE 8081

FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
ARG BUILD_CONFIGURATION=Release
WORKDIR /src
COPY ["src/hosts/CerberusSignalingApi/CerberusSignalingApi.csproj", "src/hosts/CerberusSignalingApi/"]
COPY ["src/core/DomainCore/DomainCore.csproj", "src/core/DomainCore/"]
COPY ["src/core/KeycloakClient/KeycloakClient.csproj", "src/core/KeycloakClient/"]
RUN dotnet restore "src/hosts/CerberusSignalingApi/CerberusSignalingApi.csproj"
COPY . .
WORKDIR "/src/src/hosts/CerberusSignalingApi"
RUN dotnet build "./CerberusSignalingApi.csproj" -c $BUILD_CONFIGURATION -o /app/build

FROM build AS publish
ARG BUILD_CONFIGURATION=Release
RUN dotnet publish "./CerberusSignalingApi.csproj" -c $BUILD_CONFIGURATION -o /app/publish /p:UseAppHost=false

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
COPY src/hosts/CerberusSignalingApi/Entities/webrtcbin_worker.py /app/webrtcbin_worker.py
ENTRYPOINT ["dotnet", "CerberusSignalingApi.dll"]
